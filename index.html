<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seilzieh Turnier Webseite - Pro</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            margin: 0;
            padding: 20px;
            /* NEU: Hintergrundbild */
            background-image: url('background.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-color: #f4f4f9; /* Fallback-Farbe */
        }
        main {
            max-width: 1000px;
            margin: auto;
            background: rgba(255, 255, 255, 0.95); /* Leicht transparenter Hintergrund für bessere Lesbarkeit */
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        h1, h2, h3, h4 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .hidden { display: none; }

        /* Team-Eingabe */
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        #teamNameInput { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.3s, transform 0.1s; }
        button:active { transform: scale(0.98); }
        #addTeamBtn { background-color: #2ecc71; color: white; }
        #addTeamBtn:hover { background-color: #27ae60; }
        #teamList { list-style: none; padding: 0; }
        #teamList li { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #ecf0f1; border-radius: 4px; margin-bottom: 5px; }
        .delete-btn { background-color: #e74c3c; color: white; border-radius: 50%; width: 25px; height: 25px; line-height: 25px; text-align: center; font-size: 14px; }
        .delete-btn:hover { background-color: #c0392b; }
        
        /* Turnier-Steuerung */
        #tournament-controls { margin-top: 30px; display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 15px; }
        #startTournamentBtn { background-color: #3498db; color: white; }
        #startTournamentBtn:hover { background-color: #2980b9; }
        #resetTournamentBtn { background-color: #f39c12; color: white; }
        #resetTournamentBtn:hover { background-color: #e67e22; }
        #advanceToKoBtn { background-color: #8e44ad; color: white; }
        #advanceToKoBtn:hover { background-color: #9b59b6; }
        #advanceToKoBtn:disabled { background-color: #bdc3c7; cursor: not-allowed; }

        /* Gruppen & KO-Phase Layout */
        #groupsContainer, #ko-phase > div { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px; }
        .group-container, .ko-round { border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #f9f9f9; }
        .group-container h3, .ko-round h4 { margin-top: 0; border-color: #95a5a6; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #ecf0f1; }
        
        /* Match-Styling */
        .match-list { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #ccc; }
        .match { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-radius: 4px; margin-bottom: 5px; background: #e9e9e9; }
        .match-teams { font-weight: bold; }
        .match-winner-btns button { font-size: 12px; padding: 5px 8px; margin-left: 5px; background-color: #3498db; color: white; }
        .match-winner-btns button:disabled { background-color: #7f8c8d; cursor: not-allowed; }
        .match .winner { font-weight: bold; color: #27ae60; }

        /* KO-Runden Styling */
        #final-container .match { border: 2px solid #f1c40f; }
        #final-container h4 { color: #f1c40f; border-color: #f1c40f; }
    </style>
</head>
<body>

    <main>
        <h1>Seilzieh Turnier Webseite</h1>

        <!-- SEKTION 1: TEAMVERWALTUNG -->
        <section id="team-setup">
            <h2>1. Teamverwaltung</h2>
            <div class="input-group">
                <input type="text" id="teamNameInput" placeholder="Teamnamen eingeben...">
                <button id="addTeamBtn">Team hinzufügen</button>
            </div>
            <ul id="teamList"></ul>
        </section>

        <!-- SEKTION 2: TURNIER-STEUERUNG -->
        <section id="tournament-controls">
            <div>
                <h2>2. Turnier starten</h2>
                <button id="startTournamentBtn">Turnier starten</button>
            </div>
            <div>
                <button id="advanceToKoBtn" class="hidden">Zur KO-Phase</button>
            </div>
            <div>
                <h2>Turnier zurücksetzen</h2>
                <button id="resetTournamentBtn">Turnier neustarten</button>
            </div>
        </section>

        <!-- SEKTION 3: GRUPPENPHASE -->
        <section id="group-phase" class="hidden">
            <h2>3. Gruppenphase</h2>
            <div id="groupsContainer"></div>
        </section>

        <!-- SEKTION 4: KO-PHASE -->
        <section id="ko-phase" class="hidden">
            <h2>4. KO-Phase</h2>
            <div id="quarter-finals-container" class="ko-round"><h4>Viertelfinale</h4></div>
            <div id="semi-finals-container" class="ko-round"><h4>Halbfinale</h4></div>
            <div id="third-place-container" class="ko-round"><h4>Spiel um Platz 3</h4></div>
            <div id="final-container" class="ko-round"><h4>Finale</h4></div>
        </section>

    </main>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // ##################################################################
        // KONSTANTEN & DOKUMENTATION
        // ##################################################################
        const MAX_TEAMS = 40;
        const MAX_TEAMS_PER_GROUP = 4; // Geändert
        const POINTS_PER_WIN = 2;

        const STORAGE_KEYS = {
            TEAMS: 'tournament_teams',
            DATA: 'tournament_data'
        };

        // ##################################################################
        // DOM ELEMENTE
        // ##################################################################
        const teamNameInput = document.getElementById('teamNameInput');
        const addTeamBtn = document.getElementById('addTeamBtn');
        const teamList = document.getElementById('teamList');
        const startTournamentBtn = document.getElementById('startTournamentBtn');
        const resetTournamentBtn = document.getElementById('resetTournamentBtn');
        const advanceToKoBtn = document.getElementById('advanceToKoBtn');
        
        const teamSetupSection = document.getElementById('team-setup');
        const groupPhaseSection = document.getElementById('group-phase');
        const koPhaseSection = document.getElementById('ko-phase');
        const groupsContainer = document.getElementById('groupsContainer');
        const tournamentControls = document.getElementById('tournament-controls');

        // KO-Runden Container
        const qfContainer = document.getElementById('quarter-finals-container');
        const sfContainer = document.getElementById('semi-finals-container');
        const thirdPlaceContainer = document.getElementById('third-place-container');
        const finalContainer = document.getElementById('final-container');

        // ##################################################################
        // SPEICHERFUNKTIONEN
        // ##################################################################
        const getTeamsFromStorage = () => JSON.parse(localStorage.getItem(STORAGE_KEYS.TEAMS)) || [];
        const saveTeamsToStorage = (teams) => localStorage.setItem(STORAGE_KEYS.TEAMS, JSON.stringify(teams));
        const getTournamentData = () => JSON.parse(sessionStorage.getItem(STORAGE_KEYS.DATA)) || null;
        const saveTournamentData = (data) => sessionStorage.setItem(STORAGE_KEYS.DATA, JSON.stringify(data));

        // ##################################################################
        // TEAMVERWALTUNG
        // ##################################################################
        const renderTeamList = () => {
            const teams = getTeamsFromStorage();
            teamList.innerHTML = '';
            teams.forEach(team => {
                const li = document.createElement('li');
                li.textContent = team;
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'x';
                deleteBtn.className = 'delete-btn';
                deleteBtn.onclick = () => removeTeam(team);
                li.appendChild(deleteBtn);
                teamList.appendChild(li);
            });
        };

        const addTeam = () => {
            const teamName = teamNameInput.value.trim();
            if (!teamName) { alert("Bitte gib einen Teamnamen ein."); return; }
            const teams = getTeamsFromStorage();
            if (teams.length >= MAX_TEAMS) { alert(`Maximal ${MAX_TEAMS} Teams.`); return; }
            if (teams.includes(teamName)) { alert("Dieses Team existiert bereits."); return; }
            teams.push(teamName);
            saveTeamsToStorage(teams);
            renderTeamList();
            teamNameInput.value = '';
            teamNameInput.focus();
        };

        const removeTeam = (teamNameToRemove) => {
            let teams = getTeamsFromStorage();
            teams = teams.filter(team => team !== teamNameToRemove);
            saveTeamsToStorage(teams);
            renderTeamList();
        };

        // ##################################################################
        // TURNIER-LOGIK
        // ##################################################################

        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        };

        const generateGroupMatches = (teams) => {
            const matches = [];
            for (let i = 0; i < teams.length; i++) {
                for (let j = i + 1; j < teams.length; j++) {
                    matches.push({ teamA: teams[i], teamB: teams[j], winner: null });
                }
            }
            return matches;
        };

        const startTournament = () => {
            const teams = getTeamsFromStorage();
            if (teams.length < 8) {
                alert("Es werden mindestens 8 Teams für die Gruppen- und KO-Phase benötigt.");
                return;
            }

            const shuffledTeams = shuffleArray([...teams]);
            const groups = [];
            let groupIndex = 0;

            for (let i = 0; i < shuffledTeams.length; i += MAX_TEAMS_PER_GROUP) {
                const groupTeams = shuffledTeams.slice(i, i + MAX_TEAMS_PER_GROUP);
                const standings = {};
                groupTeams.forEach(team => {
                    standings[team] = { played: 0, wins: 0, points: 0 };
                });
                groups.push({
                    name: String.fromCharCode(65 + groupIndex), // A, B, C...
                    teams: groupTeams,
                    matches: generateGroupMatches(groupTeams),
                    standings: standings,
                });
                groupIndex++;
            }
            
            const tournamentData = {
                groups: groups,
                ko_stage: null // KO-Phase wird später initialisiert
            };

            saveTournamentData(tournamentData);
            updateUI('group-phase');
        };
        
        const recordGroupWin = (groupName, matchIndex, winner) => {
            const data = getTournamentData();
            const group = data.groups.find(g => g.name === groupName);
            const match = group.matches[matchIndex];

            if (match.winner) return; // Spiel bereits gewertet

            match.winner = winner;
            const loser = match.teamA === winner ? match.teamB : match.teamA;

            group.standings[winner].wins += 1;
            group.standings[winner].points += POINTS_PER_WIN;
            group.standings[winner].played += 1;
            group.standings[loser].played += 1;

            saveTournamentData(data);
            renderGroups();
        };
        
        const areAllGroupMatchesPlayed = () => {
            const data = getTournamentData();
            return data.groups.every(g => g.matches.every(m => m.winner !== null));
        };
        
        const advanceToKoStage = () => {
            if (!areAllGroupMatchesPlayed()) {
                alert("Es müssen erst alle Gruppenspiele beendet werden!");
                return;
            }
            const data = getTournamentData();
            if (data.ko_stage) { // Falls schon initialisiert
                updateUI('ko-phase');
                return;
            }

            const qualifiers = [];
            data.groups.forEach(group => {
                const sortedTeams = Object.entries(group.standings)
                    .sort(([, a], [, b]) => b.points - a.points) // Sortiere nach Punkten
                    .slice(0, 2) // Nimm die besten 2
                    .map(([teamName]) => teamName);
                qualifiers.push({group: group.name, winner: sortedTeams[0], runnerUp: sortedTeams[1]});
            });

            // Erstelle Viertelfinal-Paarungen (z.B. A1 vs B2, B1 vs A2, etc.)
            data.ko_stage = {
                quarterFinals: [
                    { id: 'QF1', teamA: qualifiers[0].winner, teamB: qualifiers[1].runnerUp, winner: null },
                    { id: 'QF2', teamA: qualifiers[2].winner, teamB: qualifiers[3].runnerUp, winner: null },
                    { id: 'QF3', teamA: qualifiers[1].winner, teamB: qualifiers[0].runnerUp, winner: null },
                    { id: 'QF4', teamA: qualifiers[3].winner, teamB: qualifiers[2].runnerUp, winner: null },
                ],
                semiFinals: [
                    { id: 'SF1', teamA: 'Sieger QF1', teamB: 'Sieger QF2', winner: null },
                    { id: 'SF2', teamA: 'Sieger QF3', teamB: 'Sieger QF4', winner: null },
                ],
                thirdPlace: { id: '3P', teamA: 'Verlierer SF1', teamB: 'Verlierer SF2', winner: null },
                final: { id: 'F', teamA: 'Sieger SF1', teamB: 'Sieger SF2', winner: null },
            };
            
            saveTournamentData(data);
            updateUI('ko-phase');
        };

        const recordKoWin = (stage, matchId, winner) => {
            const data = getTournamentData();
            const ko = data.ko_stage;

            let match;
            let loser;

            if (stage === 'quarterFinals') {
                match = ko.quarterFinals.find(m => m.id === matchId);
                match.winner = winner;
                loser = match.teamA === winner ? match.teamB : match.teamA;
                // Halbfinale füllen
                if(matchId === 'QF1') ko.semiFinals[0].teamA = winner;
                if(matchId === 'QF2') ko.semiFinals[0].teamB = winner;
                if(matchId === 'QF3') ko.semiFinals[1].teamA = winner;
                if(matchId === 'QF4') ko.semiFinals[1].teamB = winner;

            } else if (stage === 'semiFinals') {
                match = ko.semiFinals.find(m => m.id === matchId);
                match.winner = winner;
                loser = match.teamA === winner ? match.teamB : match.teamA;
                // Finale und Spiel um Platz 3 füllen
                if(matchId === 'SF1') {
                    ko.final.teamA = winner;
                    ko.thirdPlace.teamA = loser;
                } else { // SF2
                    ko.final.teamB = winner;
                    ko.thirdPlace.teamB = loser;
                }
            } else if (stage === 'thirdPlace') {
                ko.thirdPlace.winner = winner;
            } else if (stage === 'final') {
                ko.final.winner = winner;
            }

            saveTournamentData(data);
            renderKoStage();
        };

        const resetTournament = () => {
            if (confirm("Möchtest du das Turnier wirklich zurücksetzen? Alle Teams und Ergebnisse werden gelöscht.")) {
                localStorage.removeItem(STORAGE_KEYS.TEAMS);
                sessionStorage.removeItem(STORAGE_KEYS.DATA);
                location.reload(true);
            }
        };


        // ##################################################################
        // RENDERING & UI-UPDATES
        // ##################################################################
        const updateUI = (stage) => {
            teamSetupSection.classList.add('hidden');
            groupPhaseSection.classList.add('hidden');
            koPhaseSection.classList.add('hidden');
            advanceToKoBtn.classList.add('hidden');
            startTournamentBtn.classList.add('hidden');

            if (stage === 'setup') {
                teamSetupSection.classList.remove('hidden');
                startTournamentBtn.classList.remove('hidden');
            } else if (stage === 'group-phase') {
                groupPhaseSection.classList.remove('hidden');
                advanceToKoBtn.classList.remove('hidden');
                renderGroups();
            } else if (stage === 'ko-phase') {
                groupPhaseSection.classList.remove('hidden'); // Gruppen sichtbar lassen
                koPhaseSection.classList.remove('hidden');
                advanceToKoBtn.classList.add('hidden'); // Button nach Wechsel ausblenden
                renderGroups(); // Gruppen erneut rendern (ohne Buttons)
                renderKoStage();
            }
        };

        const renderGroups = () => {
            const data = getTournamentData();
            if (!data || !data.groups) return;
            
            groupsContainer.innerHTML = '';

            data.groups.forEach(group => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'group-container';
                groupDiv.innerHTML = `<h3>Gruppe ${group.name}</h3>`;
                
                // Standings Table
                const standings = Object.entries(group.standings)
                    .sort(([,a], [,b]) => b.points - a.points); // Sortieren

                let tableHtml = `<table><thead><tr><th>Team</th><th>Sp</th><th>S</th><th>Pkt</th></tr></thead><tbody>`;
                standings.forEach(([team, stats]) => {
                    tableHtml += `<tr><td>${team}</td><td>${stats.played}</td><td>${stats.wins}</td><td>${stats.points}</td></tr>`;
                });
                tableHtml += `</tbody></table>`;
                groupDiv.innerHTML += tableHtml;

                // Matches List
                if (!data.ko_stage) { // Match-Buttons nur in der Gruppenphase anzeigen
                    const matchListDiv = document.createElement('div');
                    matchListDiv.className = 'match-list';
                    group.matches.forEach((match, index) => {
                        const matchDiv = document.createElement('div');
                        matchDiv.className = 'match';
                        let buttonsHtml = '';
                        if (match.winner) {
                            buttonsHtml = `<span class="winner">Sieger: ${match.winner}</span>`;
                        } else {
                            buttonsHtml = `<div class="match-winner-btns">
                                <button onclick="recordGroupWin('${group.name}', ${index}, '${match.teamA}')">${match.teamA}</button>
                                <button onclick="recordGroupWin('${group.name}', ${index}, '${match.teamB}')">${match.teamB}</button>
                            </div>`;
                        }
                        matchDiv.innerHTML = `<span class="match-teams">${match.teamA} vs ${match.teamB}</span> ${buttonsHtml}`;
                        matchListDiv.appendChild(matchDiv);
                    });
                    groupDiv.appendChild(matchListDiv);
                }
                groupsContainer.appendChild(groupDiv);
            });
            // Advance-Button enablen/disablen
            advanceToKoBtn.disabled = !areAllGroupMatchesPlayed();
        };
        
        const renderKoStage = () => {
            const data = getTournamentData();
            if (!data || !data.ko_stage) return;
            
            const ko = data.ko_stage;

            const createMatchHtml = (match, stage) => {
                let buttonsHtml = '';
                if (match.winner) {
                    buttonsHtml = `<span class="winner">Sieger: ${match.winner}</span>`;
                } else if (!match.teamA.startsWith('Sieger') && !match.teamA.startsWith('Verlierer')) {
                    buttonsHtml = `<div class="match-winner-btns">
                        <button onclick="recordKoWin('${stage}', '${match.id}', '${match.teamA}')">${match.teamA}</button>
                        <button onclick="recordKoWin('${stage}', '${match.id}', '${match.teamB}')">${match.teamB}</button>
                    </div>`;
                }
                return `<div class="match">
                    <span class="match-teams">${match.teamA} vs ${match.teamB}</span>
                    ${buttonsHtml}
                </div>`;
            };

            qfContainer.innerHTML = '<h4>Viertelfinale</h4>' + ko.quarterFinals.map(m => createMatchHtml(m, 'quarterFinals')).join('');
            sfContainer.innerHTML = '<h4>Halbfinale</h4>' + ko.semiFinals.map(m => createMatchHtml(m, 'semiFinals')).join('');
            thirdPlaceContainer.innerHTML = '<h4>Spiel um Platz 3</h4>' + createMatchHtml(ko.thirdPlace, 'thirdPlace');
            finalContainer.innerHTML = '<h4>Finale</h4>' + createMatchHtml(ko.final, 'final');
        };

        // ##################################################################
        // INITIALISIERUNG
        // ##################################################################
        const initializePage = () => {
            window.recordGroupWin = recordGroupWin; // Mache Funktionen global verfügbar für onclick
            window.recordKoWin = recordKoWin;

            const tournamentData = getTournamentData();
            if (tournamentData) {
                if (tournamentData.ko_stage) {
                    updateUI('ko-phase');
                } else {
                    updateUI('group-phase');
                }
            } else {
                renderTeamList();
                updateUI('setup');
            }
        };

        // Event Listeners
        addTeamBtn.addEventListener('click', addTeam);
        teamNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addTeam(); });
        startTournamentBtn.addEventListener('click', startTournament);
        resetTournamentBtn.addEventListener('click', resetTournament);
        advanceToKoBtn.addEventListener('click', advanceToKoStage);
        
        initializePage();
    });
    </script>
</body>
</html>
